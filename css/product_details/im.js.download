
/* @file nt2.js
 * @date 2016.12.08 23:09:16 
 */
!function(a,b){function c(){}return a.animate?void a.Log("nt2.js loaded"):(a.animate=function(){var a=document.documentElement.style;return a.webkitTransition!==b||a.MozTransition!==b||a.OTransition!==b||a.msTransition!==b||a.transition!==b}()?function(){var c=document.documentElement.style,d=c.webkitTransition!==b?"Webkit":c.MozTransition!==b?"Moz":c.OTransition!==b?"O":c.msTransition!==b?"ms":"",e=d+"Transition";return function(b,c,d,f){var g=[],h=[],i=[],j=[],k=b.style;return d=d||300,a.each(c,function(c,d){h[c]=a.camelize(c),a.isObject(d)?(d.to=d.to||0,g[c]=a.cssNumber[c]?d.to:parseInt(d.to,10),i[c]=a.unit(c,d.to),a.isDefined(d.from)&&a.css(b,h[c],parseInt(d.from,10)+i[c])):(g[c]=a.cssNumber[c]?parseInt(d,10):d,i[c]=a.unit(c,d),a.css(b,h[c],g[c])),j.push(c)}),setTimeout(function(){k[e]="all "+d+"ms",a.each(j,function(a,b){k[h[b]]=g[b]+i[b]})},15),setTimeout(function(){k[e]="",f&&f.call(b)},d),b}}():function(b,c,d,e){var f,g,h,i=0,j=0,k=0,l=30,m=[],n=[],o=[],p=[],q=[];for(d=d||300,a.each(c,function(c,d){o.push(a.camelize(c)),a.isObject(d)?(g=d.to,a.isDefined(d.from)?n.push(a.cssNumber[c]?d.from:parseInt(d.from,10)):n.push(a.cssNumber[c]?a(b).css(c):parseInt(a(b).css(c),10)),a.css(b,o[j],n[j]+a.unit(c,g))):(g=d,n.push(a(b).css(c))),m.push(a.cssNumber[c]?g:isNaN(parseInt(g,10))?"":parseInt(g,10)),p.push(a.unit(c,g)),j++,k++}),f=0;f<l;f++)for(q[f]=[],j=0;j<k;j++)q[f][o[j]]=a.cssNumber[o[j]]||a.isNumeric(parseInt(n[j]))?n[j]+(m[j]-n[j])/l*f+("opacity"===o[j]?"":p[j]):"";for(var r=function(){for(j=0;j<k;j++)a.css(b,o[j],q[i][o[j]]);i++};j<l;j++)h=setTimeout(r,d/l*j);return setTimeout(function(){for(j=0;j<k;j++)a.css(b,o[j],m[j]+p[j]);e&&e.call(b)},d),b},a.extend({listenerFunctions:[],listenerMessage:function(b){function c(b){a.each(a.listenerFunctions,function(c,d){d.apply(a,[b.data])})}a.listenerFunctions.push(b),window.addEventListener&&this.__listenerMessage!==!0&&(window.addEventListener("message",c),this.__listenerMessage=!0)},postMessage:function(a,b,c){if(a.postMessage){c=c||"*";try{a.postMessage(b,c)}catch(d){}}}}),a.Window=a.Class.create(),a.Window.prototype={defaultOptions:{dropHeight:30,width:520,height:410,left:100,top:100,minWidth:520,minHeight:410,resize:!1,drag:!1,fixed:!1,zIndex:1e6,rightNode:!0,onChanage:c,onClose:c,onMinimize:c,onMaximize:c,onMaxResize:c},_tmpMove:null,_tmpStop:null,containter:null,header:null,body:null,chatBody:null,rightElement:null,buttonResize:null,buttonClose:null,buttonMax:null,buttonMin:null,_x:0,_y:0,_isdrag:null,_Style:null,parent:null,initialize:function(b,c){a.extend(this,this.defaultOptions,b),this.parent=c||null,this.quirks=a.browser.msie6||a.browser.Quirks&&a.browser.oldmsie,this.right=a(window).width()-this.left-this.width,this.bottom=a(window).height()-this.top-this.height,a.Log("$.Window:: left:"+this.left+", top:"+this.top),this._create(),this._bind()},close:function(b){this.cancelBubble(b),this.onClose.toString().indexOf("anonymous")<=-1?this.onClose():this.containter.hide(function(){a(this).remove()})},change:function(a){a&&this.onChanage.call(this,{width:this.width,height:this.height}),this._isdrag||(this.chatBody.css({height:this.height-this.dropHeight+"px"}),this.rightNode&&this.rightElement.css("height",this.height-this.dropHeight+"px"))},maxresize:function(){this.onMaxResize()},minimize:function(a,b){b!==!0&&this.cancelBubble(a),this.containter.css({height:"0px",width:"0px"}),b!==!0&&this.onMinimize()},maximize:function(a,b){this.containter.css({height:this.height+"px",width:this.width+"px"}),b!==!0&&this.onMaximize()},cancelBubble:function(b){this.containter.css("z-index",this.zIndex),a.Event.fixEvent(b).stopPropagation()},changeAttr:function(b,c){this.quirks&&this.clearExpression(),a.extend(this,{width:b,height:c,left:Math.max(0,a(window).width()-this.right-b),top:Math.max(0,a(window).height()-this.bottom-c)}),this.containter.css({width:this.width+"px",height:this.height+"px",left:this.left+"px",top:this.top+"px"}),this.quirks&&this.fixedPosition(),this.change(!0)},start:function(b,c){c||this.cancelBubble(b),this._Style=c?{x:"left",y:"top"}:{x:"width",y:"height"},this.right=a(window).width()-this.left-this.width,this.bottom=a(window).height()-this.top-this.height,this.quirks&&!c&&this.clearExpression(),b=a.Event.fixEvent(b),this.containter.css(c?{"z-index":++this.zIndex}:{"z-index":++this.zIndex}),this._isdrag=c,this._x=c?b.clientX-this.containter.get(0).offsetLeft||0:this.containter.get(0).offsetLeft||0,this._y=c?b.clientY-this.containter.get(0).offsetTop||0:this.containter.get(0).offsetTop||0,a.browser.msie?this.containter.bind("losecapture",this._tmpStop).get(0).setCapture():(a.Event.fixEvent(b).preventDefault(),a(window).bind("blur",this._tmpStop)),a(document).bind("mousemove",this._tmpMove),a(document).bind("mouseup",this._tmpStop)},move:function(b){window.getSelection?window.getSelection().removeAllRanges():document.selection.empty(),b=a.Event.fixEvent(b);var c=b.clientX-this._x,d=b.clientY-this._y,e=a(window).offset();this._isdrag?(this.quirks?(this[this._Style.x]=Math.min(Math.max(c,e.left),e.left+a(window).width()-this.width)-e.left,this[this._Style.y]=Math.min(Math.max(d,e.top),e.top+a(window).height()-this.height)-e.top):(this[this._Style.x]=Math.min(Math.max(c,0),a(window).width()-this.width),this[this._Style.y]=Math.min(Math.max(d,0),a(window).height()-this.height)),this.containter.css(this._Style.x,(this.quirks?e.left:0)+Math.max(0,this[this._Style.x])+"px"),this.containter.css(this._Style.y,(this.quirks?e.top:0)+Math.max(0,this[this._Style.y])+"px")):(this.quirks?(this[this._Style.x]=Math.min(Math.max(c+(this.quirks?e.left:0),this.minWidth),a(window).width()-this.left),this[this._Style.y]=Math.min(Math.max(d+(this.quirks?e.top:0),this.minHeight),a(window).height()-this.top)):(this[this._Style.x]=Math.min(Math.max(c,this.minWidth),a(window).width()-this.left),this[this._Style.y]=Math.min(Math.max(d,this.minHeight),a(window).height()-this.top)),this.containter.css(this._Style.x,this[this._Style.x]+"px"),this.containter.css(this._Style.y,this[this._Style.y]+"px")),this.right=a(window).width()-this.left-this.width,this.bottom=a(window).height()-this.top-this.height,this.change(!0)},stop:function(){this.quirks&&this.fixedPosition(),this.containter.css({"z-index":--this.zIndex}),a(document).removeEvent("mousemove",this._tmpMove),a(document).removeEvent("mouseup",this._tmpStop),a.browser.msie?this.containter.removeEvent("losecapture",this._tmpStop).get(0).releaseCapture():a(window).removeEvent("blur",this._tmpStop)},fixedPosition:function(){if(this.quirks){var b=a(window).scrollTop();a(window).scrollTop(b+1),this.containter.replaceIEcssText({left:"expression(eval(Math.max((document.documentElement.scrollLeft || document.body.scrollLeft), (document.documentElement.scrollLeft || document.body.scrollLeft) + (document.documentElement.clientWidth  || document.body.clientWidth ) - this.offsetWidth  - "+this.right+")))",top:"expression(eval(Math.max((document.documentElement.scrollTop  || document.body.scrollTop ), (document.documentElement.scrollTop  || document.body.scrollTop ) + (document.documentElement.clientHeight || document.body.clientHeight) - this.offsetHeight - "+this.bottom+")))"}),a(window).scrollTop(b),a(window).scrollLeft(1)}else this.containter.css({left:this.left+"px",top:this.top+"px"})},clearExpression:function(){var b=a(window).offset();this.containter.Expression("left",""),this.containter.Expression("top",""),this.containter.Expression("left",""),this.containter.replaceIEcssText({left:b.left+this.left+"px",top:b.top+this.top+"px"})},_for_resize:function(){this.left=Math.max(0,a(window).width()-this.right-this.width),this.top=Math.max(0,a(window).height()-this.bottom-this.height),this.quirks||this.containter.css({left:this.left+"px",top:this.top+"px"})},_create:function(){return this.containter=a({className:this.className||"ntalk-window-containter",style:a.STYLE_BODY+"box-sizing:content-box;overflow:hidden;"}).appendTo(this.parent,!0).css({position:this.fixed?this.quirks?"absolute":"fixed":"absolute",border:"none",width:this.width+"px",height:this.height+"px",zIndex:this.zIndex}),this.fixedPosition(),this.header=a({className:"ntalk-window-head",style:a.STYLE_BODY+"cursor:move;position:relative;left:0;top:0;"}).appendTo(this.containter).css({width:"100%",height:this.dropHeight+"px"}),this.buttonClose=a({className:"ntalk-button-close",style:a.STYLE_BODY+"width:20px;height:20px;cursor:pointer;position:static;float:right;position:relative;margin:2px 3px 0 0;line-height:20px;vertical-align:middle;background:none;"}).appendTo(this.header),this.buttonMax=a({className:"ntalk-button-maxresize",style:a.STYLE_BODY+"width:20px;height:20px;cursor:pointer;position:static;float:right;position:relative;margin:2px 3px 0 0;line-height:20px;vertical-align:middle;background:none;"}).appendTo(this.header),this.buttonMin=a({className:"ntalk-button-min",style:a.STYLE_BODY+"width:20px;height:20px;cursor:pointer;position:static;float:right;position:relative;margin:2px 3px 0 0;line-height:20px;vertical-align:middle;background:none;"}).appendTo(this.header),this.body=a({className:"ntalk-window-body",style:a.STYLE_BODY+"float:left;width:100%;"}).appendTo(this.containter),this.chatBody=a({className:"ntalk-chat-body",style:a.STYLE_BODY+"width:100%;position:relative;left:0;top:0;"}).appendTo(this.body),this.rightNode&&(this.rightElement=a({className:"ntalk-window-right",style:a.STYLE_BODY+"float:left;display:none;width:100%;"}).appendTo(this.containter)),this.resize&&(this.buttonResize=a({className:"window-resize",style:a.STYLE_BODY+"width:10px;height:10px;cursor:nw-resize;position:absolute;right:1px;bottom:1px;font-size:0;background:none;z-index:99;"}).appendTo(this.containter)),a({style:a.STYLE_BODY+"clear:both;"}).appendTo(this.containter),this.change(),this.containter},_bind:function(){var b=this;this.containter.bind("mousedown",function(a){b.drag&&b.start.call(b,a,!0)}),this.buttonClose.bind("mousedown",function(c){a.Event.fixEvent(c).stopPropagation(),b.close.call(b,c)}),this.buttonMax.bind("mousedown",function(c){a.Event.fixEvent(c).stopPropagation(),b.maxresize.call(b,c)}),this.buttonMin.bind("mousedown",function(c){a.Event.fixEvent(c).stopPropagation(),b.minimize.call(b,c)}),this.chatBody.bind("mousedown",function(a){b.cancelBubble.call(b,a)}),this.rightNode&&this.rightElement.bind("mousedown",function(a){b.cancelBubble.call(b,a)}),this.resize&&this.buttonResize.bind("mousedown",function(a){b.start.call(b,a,!1)}),this.fixed&&a(window).bind("resize",function(){b._for_resize()}),this._tmpStop=function(a){b.stop.call(b,a)},this._tmpMove=function(a){b.move.call(b,a)}}},a.Queue=a.Class.create(),a.Queue.prototype={list:null,length:0,initialize:function(){this.list=[],this.length=this.list.length},isEmpty:function(){return 0===this.list.length},enQueue:function(a){return this.list.push(a),this.length=this.list.length,this.list[this.length-1]},deQueue:function(){var a;return this.isEmpty()?null:(a=this.list.shift(),this.length=this.list.length,a)},queueFront:function(){return this.isEmpty()?null:this.list[0]}},a.pageManage=a.Class.create(),a.pageManage.prototype={identid:"",keyid:"",data:null,interID:null,options:null,debug:!1,inter:.8,count:0,chanageCall:!0,CON_MANAGE_PAGE_LIST:"IM_EXIST_PAGEARR",pageStore:null,initialize:function(b,d){var e,f,g=this,h=3;this.debug&&a.Log("pageManage.initialize():"),this.options=a.extend(this.options,{onChanage:c,onInterval:c,pageNum:3,timeout:2.5,inter:.8},b),this.keyid=a.CON_MANAGE_COOKIE+(d?"_"+d.toUpperCase():""),this.identid=this._2shortTime(0,8,13),a.browser.chrome&&(this.options.timeout=5),this.options.timeout*=10,this.options.inter*=1e3,this.inter=this.options.inter,this.pageStore=a.store;try{for(;h--&&(e=this.pageStore.get(this.CON_MANAGE_PAGE_LIST)||"",""===e););if(f=this._get().m,e=""===e||0===f.length?[]:e.split(","),e.length!=f.length&&e.length<=this.options.pageNum){e=[];for(var i=0;i<f.length;i++)for(var j in f[i])e.push(j)}e.push(this.identid),this.pageStore.set(this.CON_MANAGE_PAGE_LIST,e.join(","))}catch(k){}var l=a.getTime();this.interID=setInterval(function(){setTimeout(function(){now=a.getTime();var b=now-l;g._update(b),g.options.onInterval(g.options.timeout,g.data.m),l=a.getTime()},0)},this.options.inter),a.Event.addEvent(window,"unload",function(){g._remove(),setTimeout(function(){},500)})},getIsLastPage:function(){return this.data.m.length},_get:function(){var b=a.cookie.get(this.keyid)||"{}";return a.extend({m:[]},a.JSON.parseJSON(b))},_save:function(){var b=a.JSON.toJSONString(this.data);return a.cookie.set(this.keyid,b,0),b},_remove:function(){var a=this._getIndex();this.data.m.splice(a,1),this._save();var b=this.pageStore.get(this.CON_MANAGE_PAGE_LIST);if(b&&""!==b){for(var c=b.split(","),d=0;d<c.length;d++)if(c[d]==this.identid){c.splice(d,1);break}b=c.join(","),""!==b?this.pageStore.set(this.CON_MANAGE_PAGE_LIST,b):this.pageStore.whereClear(this.CON_MANAGE_PAGE_LIST)}},_update:function(b){this.data=this._get(),this._clear(b);var c="update",d=this._getIndex();if(this.data.t=a.formatDate(),!this.data.m[d]){if(!(this.data.m.length<this.options.pageNum))return;c="add",this.data.m[d]={}}this.data.m[d][this.identid]=this._2shortTime(),this._save(),this.debug&&a.Log(this.identid+",pageCount:"+this.data.m.length+","+c+" data:"+a.JSON.toJSONString(this.data.m)),"add"!=c&&this.chanageCall===!0||this.count==this.data.m.length||(this.options.onChanage.call(this,this.data.m.length,this.data.m),this.count=this.data.m.length),this.chanageCall=!1},_clear:function(a){var b=this._2shortTime();if(this.data.m.length)for(var c,d=0;d<this.data.m.length;d++)if(this.data.m[d])for(var e in this.data.m[d])if("function"!=typeof this.data.m[d][e]&&(c=b-this.data.m[d][e],Math.abs(c)>this.options.timeout+a/100)){this.data.m.splice(d,1),this.chanageCall=!0;var f=this.pageStore.get(this.CON_MANAGE_PAGE_LIST);if(!f||""===f)return;for(var g=f.split(","),h=0;h<g.length;h++)if(g[h]==e){g.splice(h,1);break}f=g.join(","),""!==f?this.pageStore.set(this.CON_MANAGE_PAGE_LIST,f):this.pageStore.whereClear(this.CON_MANAGE_PAGE_LIST)}},_getIndex:function(){if(!this.data.m.length)return 0;for(var b=0;b<this.data.m.length;b++)if(this.data.m[b])for(var c in this.data.m[b])if(this.data.m[b]&&!a.isFunction(this.data.m[b][c])&&c===this.identid)return b;return b},_2shortTime:function(b,c,d){var e=(b?b:a.getTime()).toString();return c=c||5,d=d||11,e.substring(c,d)}},a.store=function(){var d,e="__cometd__",f={disabled:!1},g=function(){var b=null;try{b=window.localStorage}catch(c){return a.Log("localStorage:"+c.message,3),!1}if(b){var d="test";try{return null!==localStorage.getItem(d)&&localStorage.removeItem(d),localStorage.setItem(d,d),localStorage.getItem(d)==d&&(localStorage.removeItem(d),!0)}catch(c){return a.Log("The browser localStorage is unavailable. "+c.message,3),!1}}},h=a.browser.msie;if(f.toJSONString=function(b){return null===b?"":a.JSON.toJSONString(b)},f.parseJSON=function(c){if("object"==typeof c)return c||b;try{return a.JSON.parseJSON(c)}catch(d){return c||b}},g())d=window.localStorage,f.set=function(c,e){if(!e||e===b||null===e)return f.remove(c);try{"function"==typeof d.setItem?d.setItem(c,f.toJSONString(e)):d[c]=f.toJSONString(e)}catch(g){if("QUOTA_EXCEEDED_ERR"==g.name.toUpperCase()){f.remove(c);try{d.setItem(c,f.toJSONString(e))}catch(h){a.Log("store.set:"+h.message,3)}}}return e},f.get=function(a){return f.parseJSON(d.getItem(a))},f.remove=function(b){try{d.removeItem(b)}catch(c){a.Log("store.remove:"+c.message,3)}},f.clear=function(){try{d.clear()}catch(b){a.Log("store.clear:"+b.message,3)}},f.getAll=function(){for(var a={},b=0;b<d.length;++b){var c=d.key(b);a[c]=f.get(c)}return a};else if(h){var i,j,k=new RegExp("[!\"#$%&'()*+,/\\\\:;<=>?@[\\]^`{|}~]","g"),l=function(a){return function(){var b,c=Array.prototype.slice.call(arguments,0);c.unshift(d);try{i.appendChild(d)}catch(e){i.insertBefore(d,i.firstChild)}d.addBehavior&&d.addBehavior("#default#userData");for(var g=20;g>0;){g--;try{d.load("nTK-LS");break}catch(e){}}return b=a.apply(f,c),i.removeChild(d),b}},m=function(a){return a.replace(k,"___")};try{j=new ActiveXObject("htmlfile"),j.open(),j.write('<script type="text/javascript">document.w=window;</script><iframe src="/favicon.ico"></iframe>'),j.close(),i=j.w.frames[0].document,d=i.createElement("div")}catch(n){d=document.createElement("div"),i=document.body||document.getElementsByTagName("head")[0]||document.documentElement}f.set=l(function(a,c,d){if(c=m(c),!d||d===b||null===d)return f.remove(c);a.setAttribute(c,f.toJSONString(d));try{a.save("nTK-LS")}catch(e){}return d}),f.get=l(function(a,b){return b=m(b),f.parseJSON(a.getAttribute(b))}),f.remove=l(function(a,b){b=m(b),a.removeAttribute(b),a.save("nTK-LS")}),f.clear=l(function(a){var b;try{b=a.XMLDocument.documentElement.attributes}catch(c){return}a.load("nTK-LS");for(var d=0,e=b.length;d<e;d++){var f=b[d];a.removeAttribute(f.name)}a.save("nTK-LS")}),f.getAll=l(function(a){var b;try{b=a.XMLDocument.documentElement.attributes}catch(c){return}for(var d={},e=0,g=b.length;e<g;++e){var h=b[e],i=m(h.name);d[h.name]=f.parseJSON(a.getAttribute(i))}return d})}else f.set=function(){a.Log("The browser localStorage is unavailable.",3)},f.get=c,f.remove=c,f.clear=c,f.getAll=c;try{f.set(e,e),f.get(e)!=e&&(f.disabled=!0),f.remove(e)}catch(n){f.disabled=!0}return f.whereClear=function(b){var c=this,d=this.getAll();a.each(d,function(a){a.indexOf(b)>-1&&c.remove(a)})},f.enabled=!f.disabled,f}(),a.comet=a.Class.create(),a.comet.prototype={name:"public.comet",version:"2014.05.17",connType:"login",options:null,fix:"",id:"",count:0,sendIntervalID:null,_ipExpr:/^https?:\/\/\d+\.\d+\.\d+\.\d+(:\d+)?\/(.*?)$/gi,_cacheElement:{},_connectTimeID:{},defaultOption:{muDomain:3,timeout:20,onCallback:c,onComplete:c,onAbnormal:c,onTimeout:c},initialize:function(b,c){var d=this;this.uri=b,this.fix=a.randomChar(),this.uri||a.Log("comet uri is null",3),this.callMethod=window,this.callbackName="callback_"+this.fix,this.callMethod[this.callbackName]=function(){d._connectCallback.call(d,d.id,arguments)},this.options=a.extend({},this.defaultOption,c),this.initConnectionPooling()},initMessageQueue:function(){this.messageQueue||(this.messageQueue=new a.Queue,this.messageQueue.addMessage=function(a){for(var b=0;b<this.length;b++)if(this.list[b].msgid==a.msgid&&this.list[b].index==a.index)return!1;return this.enQueue(a),!0},this.messageQueue.nextMessage=function(a,b){if(this.isEmpty())return null;if(!a)return this.queueFront();for(var c=0;c<this.length;c++)if(this.list[c].msgid==a&&this.list[c].body.sendpacket==b)return this.list[c+1]},this.messageQueue.removeMessage=function(a,b){for(var c,d=0;d<this.length;d++)this.list[d].msgid!=a||this.list[d].index!=b&&b!=-1||(c=d);this.list.splice(d,1),this.length=this.list.length})},initConnectionPooling:function(){if(!this.connectionPooling){this._ipExpr.test(this.uri)&&(this.options.muDomain=1),this.connectionPooling=new a.Queue,this.connectionPooling.get=function(){for(var a,b,c,d=0;d<this.list.length;d++)this.list[d].lock===!1&&(!b||b.rTimesample>this.list[d].rTimesample)&&(b=this.list[d]),(!c||this.list[d].sTimesample<c.sTimesample)&&(c=this.list[d]);return a=b||c,this.recover(a.uri,!0),a},this.connectionPooling.getConnect=function(){var a=this.get();return{uri:a.uri,url:a.uri+(/\?$/gi.test(a.uri)?"&":"?")}},this.connectionPooling.recover=function(b,c,d,e){for(var f=0;f<this.list.length;f++)if(this.list[f].uri==b)return this.list[f].lock=c,c?(this.list[f].sTimesample=d||a.getTime(),this.list[f].rTimesample=0):this.list[f].rTimesample=e||a.getTime(),!0;return!1};for(var b=0;b<=this.options.muDomain;b++)this.connectionPooling.enQueue({uri:0===b?this.uri.toString().replace(/(https?:\/\/)(.*?)(\-\d+)?\./gi,"$1$2."):this.uri.toString().replace(/(https?:\/\/)(.*?)(\-\d+)?\./gi,"$1$2-"+(+b-1)+"."),lock:!1,sTimesample:0,rTimesample:0})}},connect:function(b,c){var d,e,f=this.count++;this.connType="login",this.id=this.fix+"_"+f,b[c||"callbackname"]=this.callbackName,this.connectOptions=a.extend(b,{ts:a.getTime()}),d=this.connectionPooling.getConnect(),e=d.url+a.toURI(this.connectOptions),this._cacheElement[this.id]=this._createConnect(e,this.id,f,d)},kalive:function(b,c){var d,e,f=this.count++;this.connType="kalive",this.id=this.fix+"_"+f,b[c||"callbackname"]=this.callbackName,this.kaliveOptions=a.extend(this.kaliveOptions,b,{ts:a.getTime()}),d=this.connectionPooling.getConnect(),e=d.url+a.toURI(this.kaliveOptions),this._cacheElement[this.id]=this._createConnect(e,this.id,f,d)},disconnectServer:function(b,c){var d=this.connectionPooling.getConnect();return this.flashGoServer=d.url+a.toURI(c===!1?b:a.extend(b,{ts:a.getTime()})),this.flashGoServer},disconnect:function(){a.require(this.flashGoServer,function(b){a(b.error?b.target:b).remove()}),window[this.callbackName]=c},reconnect:function(){this.connect(this.connectOptions)},send:function(b,c){var d=this,e=this.connectionPooling.getConnect(),f=this.mdyServerAddr(e.url)+a.toURI(b);return a.require(f+"#rnd",function(b){d.connectionPooling.recover(e.uri,!1),c&&c.call(d,b.error),a(b.error?b.target:b).remove()}),!0},mdyServerAddr:function(a){return a.replace(/\/flashgo/i,"/httpgo")},post:function(b,c){var d=this,e=this.connectionPooling.getConnect();new a.POST(this.mdyServerAddr(e.url),b,function(){d.connectionPooling.recover(e.uri,!1),c&&c.call(d,!0)})},_createConnect:function(b,c,d,e){var f,g,h=this,i=document.head||nTalk("head")[0]||document.documentElement;return f=a({className:c,tag:"script",type:"text/javascript",async:"async",src:b,charset:"utf-8"}).appendTo(i),g=f.get(0).readyState?"onreadystatechange":"onload",f.get(0)[g]=f.get(0).onerror=function(b){var d=/^(loaded|complete|undefined)$/,g=f.get(0).readyState;b=a.Event.fixEvent(b),d.test(g)&&(h.connectionPooling.recover(e.uri,!1),"error"!==b.type?setTimeout(function(){h._connectComplete(b,c),f.remove()},a.browser.msie?800:50):(h._connectAbnormal(b,c),f.remove()))},this._connectTimeID[c]=setTimeout(function(){f.first().remove(),h._connectTimeout("timeout",c)},1e3*+this.options.timeout+1e4),f.get(0)},_connectCallback:function(b,c){c=Array.prototype.slice.call(c),a("."+b).remove(),this._cacheElement[b]?(this._stopCallComplete(b,"callback"),this.options.onCallback.apply(self,[!0,c])):this.options.onCallback.apply(self,[!1,c])},_connectComplete:function(a,b){var c=Array.prototype.slice.call(arguments);this._cacheElement[b]&&(this._stopCallComplete(b,"complete"),this.options.onComplete.apply(self,[this.connType].concat(c)))},_connectAbnormal:function(a,b){var c=Array.prototype.slice.call(arguments);this._cacheElement[b]&&(this._stopCallComplete(b,"abnormal"),this.options.onAbnormal.apply(self,[this.connType].concat(c)))},_connectTimeout:function(a,b){var c=Array.prototype.slice.call(arguments);this._cacheElement[b]&&(this._stopCallComplete(b,"timeout"),this.options.onTimeout.apply(self,[this.connType].concat(c)))},_stopCallComplete:function(b){var d=this._cacheElement[b];d?d.onload=d.onreadystatechange=d.onerror=c:a.Log("stop error id:"+b,3),delete this._cacheElement[b],clearTimeout(this._connectTimeID[b]),delete this._connectTimeID[b]},_createScriptPCID:function(b){return"guest"+[b?"TEMP"+a.randomChar(4):a.randomChar(8),a.randomChar(4),a.randomChar(4),a.randomChar(4),a.randomChar(12)].join("-")}},a.mqttws=a.Class.create(),a.mqttws.prototype={name:"public.mqttws",version:"2015.04.10",connect:null,subscriptions:[],messages:[],connected:!1,recCount:0,waitTime:500,_wsKeepaliveId:null,_options:{url:null,siteid:null,pcid:null,onCallback:null,loginMsg:null,timeout:3,keepAliveInterval:90},initialize:function(b){var c=this;this.options=a.extend({},c._options,b),this.options.pcid=(this.options.siteid+"_"+this.options.pcid.substring(5)).substring(0,23),a.require({mqtt:"mosquitto.js?siteid="+a.extParmas.siteid},function(b){c.connect=new a.Mosquitto,c.connect.onmessage=function(b,d,e,f){var g=a.JSON.parseJSON(d);c.options.onCallback.apply(this,[!0,[g.method].concat(g.params)])},c.connect.ondisconnect=function(a){null!==this._wsKeepaliveId&&(clearInterval(this._wsKeepaliveId),this._wsKeepaliveId=null)},c.connect.onconnect=function(a){0===a?(c.connect.subscribe("foo",0),c.connect.publish("foo",c.options.loginMsg,0,0)):c.reconnect()},c.connect.onreconnect=function(){c.reconnect()},c.connect.connect(c.options.url,c.options.keepAliveInterval,c.options.pcid)})},reconnect:function(){var a=this;++this.recCount<3?this._waitTime=500:this._waitTime=1e3*+"034567890".charAt(Math.ceil(5*Math.random())),setTimeout(function(){a.connect.connect(a.options.url,a.options.keepAliveInterval,a.options.pcid)},this._waitTime)},disconnect:function(){this.connect.closeFlag=!0,this.connect.disconnect()},kalive:function(a){var b=this;this._wsKeepaliveId||(this._wsKeepaliveId=setInterval(function(){b.connect.publish("foo",a,0,!1)},1e3*this.options.keepAliveInterval))}},a.extend({htmlToElement:function(b){var c,d;if(a.browser.msie)try{c=new ActiveXObject("MSXml.DOMDocument"),c.loadXML(b),d=c.childNodes}catch(e){c=document.createElement("DIV"),c.innerHTML=b,d=c.childNodes}else c=document.createElement("DIV"),c.innerHTML=b,d=c.childNodes;return d},elementToObject:function(b){var c,d,e={};if(d=a.isArray(b)||b.talkVersion?b[0]:b,e[d.tagName.toLowerCase()]=d.innerHTML||d.text,d.attributes)for(var f=0;f<d.attributes.length;f++)c=d.attributes[f].name,c&&(e[c]=d.attributes[f].value);else e.msg=d.textContent;return e},jsonToxml:function(b){var c,d=this,e="";return"object"!=typeof b?b:(a.each(b,function(f,g){if("string"==typeof g&&"text"==f)e=g;else if(a.isArray(b))e+=d.jsonToxml(g);else{if(e+="<"+f,"object"==typeof g.attributes){for(var h in g.attributes)g.attributes.hasOwnProperty(h)&&(e+=" "+h+'="'+g.attributes[h]+'"');delete g.attributes}c=d.jsonToxml(g),e+=g&&c?">"+c+"</"+f+">":"></"+f+">"}}),e)},utils:{options:{},handleLinks:function(b,c){this.options=a.extend({},this.options,c),b=b||"";for(var d=0;d<this.linkPatterns.length;d++)b=b.replace(this.linkPatterns[d][0],this.linkPatterns[d][1]);return b},linkPatterns:[[/\[link\s+reconnect=([^\s\[\]'"]+)\s*[^\[\]]*]([^\[\]]+)\[\/\s*link]/gi,'<a style="'+a.STYLE_BODY+'display:inline-block;color:#005ffb;text-decoration:none;" href="javascript:void(0);" onclick="nTalk.chatManage.get(\'$1\').reconnect(this);return false;" >$2</a>'],[/\[link\s+message=([^\s\[\]'"]+)\s*[^\[\]]\s*source=([^\s\[\]'"]+)\s*[^\[\]]*]([^\[\]]+)\[\/\s*link]/gi,'<a style="'+a.STYLE_BODY+"display:inline-block;color:#005ffb;text-decoration:none;font-size:"+(a.browser.mobile?14:12)+'px;" href="javascript:void(0);" onclick="nTalk.chatManage.get(\'$1\').switchUI(\'message\', $2);return false;" >$3</a>'],[/\[link\s+cancel=([^\s\[\]'"]+)\s+action=([^\s\[\]'"]+)\s*[^\[\]]*]([^\[\]]+)\[\/\s*link]/gi,'<a style="'+a.STYLE_BODY+'display:inline-block;color:#005ffb;text-decoration:none;" href="javascript:void(0);" onclick="nTalk.chatManage.get(\'$1\').cancelUpload(\'$2\');return false;" >$3</a>'],[/\[link\s+resend=([^\s\[\]'"]+)\s+msgid=([^\s\[\]'"]+)\s*[^\[\]]*]([^\[\]]+)\[\/\s*link]/gi,'<a style="'+a.STYLE_BODY+'display:inline-block;color:#005ffb;text-decoration:none;" href="javascript:void(0);" onclick="nTalk.chatManage.get(\'$1\').resend(\'$2\', this);return false;" >$3</a>'],[/\[link\s*manual=([^\s\[\]'"]+)](.*?)\[\/link]/gi,'<a style="'+a.STYLE_BODY+'display:inline-block;color:#005ffb;text-decoration:none;" href="javascript:void(0);" onclick="nTalk.chatManage.get(\'$1\').switchServerType(true);return false;" >$2</a>'],[/\[link\s*artificial=([^\s\[\]'"]+)](.*?)\[\/link]/gi,'<a style="'+a.STYLE_BODY+'display:inline-block;color:#005ffb;text-decoration:none;" href="javascript:void(0);" onclick="nTalk.chatManage.get(\'$1\').switchServerType(true);return false;" >$2</a>'],[/\[link\s*robot](.*?)\[\/link]/gi,'<a style="'+a.STYLE_BODY+'display:inline-block;color:#005ffb;text-decoration:none;" href="javascript:void(0);" onclick="nTalk.chatManage.get().switchServerType(false, 2);return false;" >$1</a>'],[/\[link\s*robotindex=([^\s\[\]'"]+)\s*\](.*?)\[\/link]/gi,'<a style="'+a.STYLE_BODY+'display:inline-block;color:#005ffb;text-decoration:none;" href="javascript:void(0);" onclick="nTalk.chatManage.get(\'{$settingid}\').send(\'$1\');return false;">$2</a>'],[/\[link\s*rightTag=true\s*url="(.*?)"\s*close=(.*?)\s*title="(.*?)"\s*\](.*?)\[\/link\]/gi,'<span style="'+a.STYLE_BODY+'display:inline-block;color:#005ffb;text-decoration:none;cursor:pointer;" rightTag="true" src="$1" closeBtn="$2" title="$3">$4</span>'],[/\[xnlink](.*?)\[\/xnlink]/gi,'<span class="robotQuestion" style="'+a.STYLE_BODY+'display:inline-block;color:#005ffb;text-decoration:none;cursor:pointer;" href="javascript:void(0);" >$1</span>'],[/\[link\s*href=(.*?)](.*?)\[\/link]/gi,'<a style="'+a.STYLE_BODY+'display:inline-block;color:#005ffb;text-decoration:none;cursor:pointer;" href="$1">$2</a>'],[/\[link\s*(.*?)?](.*?)\[\/link]/gi,'<a style="'+a.STYLE_BODY+'display:inline-block;color:#005ffb;text-decoration:none;cursor:pointer;" href="javascript:void(0);"'+(a.browser.iOS?' href="$1" target="_blank"':" onclick=\"window.open('$1')\"")+">$2</a>"],[/\{\$(\w+)}/gi,function(b,c){return a.utils.options[c]||""}]]},toHSL:function(b){return a.isHex(b)?a.rgb2HSL(a.hex2RGB(b)):a.isRGB(b)?a.rgb2HSL(b):b},isHex:function(a){return"string"==typeof a&&/^#?([0-9a-f]{3}|[0-9a-f]{6})$/gi.test(a)},isRGB:function(b){return a.isObject(b)&&a.isDefined(b.r)&&a.isDefined(b.g)&&a.isDefined(b.b)},isHSL:function(b){return a.isObject(b)&&a.isDefined(b.h)&&a.isDefined(b.s)&&a.isDefined(b.l)},hex2RGB:function(a){var b=a.toString().replace("#",""),c=b.split(""),d={};return d=3==b.length?{r:parseInt(c[0]+c[0],16),g:parseInt(c[1]+c[1],16),b:parseInt(c[2]+c[2],16)}:6==b.length?{r:parseInt(c[0]+c[1],16),g:parseInt(c[2]+c[3],16),b:parseInt(c[4]+c[5],16)}:{r:0,g:0,b:0}},rgb2HSL:function(a){var b,c,d,e,f,g,h,i,j,k={};return b=a.r/255,c=a.g/255,d=a.b/255,h=Math.min(b,c,d),i=Math.max(b,c,d),j=i-h,k.l=(i+h)/2,0===j?(k.h=0,k.s=0):(k.l<.5?k.s=j/(i+h):k.s=j/(2-i-h),e=((i-b)/6+j/2)/j,f=((i-c)/6+j/2)/j,g=((i-d)/6+j/2)/j,b==i?k.h=g-f:c==i?k.h=1/3-g+e:d==i&&(k.h=2/3-e+f),k.h<0&&(k.h+=1),k.h>1&&(k.h-=1)),k}}),a.fn.extend({animate:function(b,c,d){return a.each(this,function(e,f){a.animate(f,b,c,d)})},show:function(b,c){return a.isFunction(b)&&(c=b,b=500),this.animate({visibility:"visible",opacity:{from:0,to:1}},b||500,c)},hide:function(b,c){return a.isFunction(b)&&(c=b,b=500),this.animate({opacity:{to:0}},b||500,c)},gradient:function(b,c,d){var e,f;return b?a.each(this,function(g,h){if(a.browser.oldmsie&&(e=/top|bottom/.test(b)?0:1,/right|bottom/.test(b)&&(f=c,c=d,d=f)),a.browser.webkit){switch(b){case"top":e="0% 100%,0% 0%";break;case"right":e="0% 0%,100% 0%";break;case"bottom":e="0% 0%,0% 100%";break;case"left":e="100% 0%,0% 0%"}a(h).css("background-image",b?"-webkit-gradient(linear,"+e+",color-stop(1, "+c+"),color-stop(0, "+d+"))":"none")}else if(a.browser.gecko)a(h).css("background-image",b?"-moz-linear-gradient("+b+", "+c+", "+d+")":"none");else if(a.browser.oldmsie){var i=/progid:DXImageTransform\.Microsoft\.gradient\((.*?)\)\s*/gi;h.style.filter=h.currentStyle.filter.replace(i,"")+(b?" progid:DXImageTransform.Microsoft.gradient(GradientType="+e+",startColorstr='"+c+"', endColorstr='"+d+"')":"")}else a.browser.msie?a(h).css("background-image",b?"-ms-linear-gradient("+b+", "+c+", "+d+")":"none"):a(h).css("background-image",b?"linear-gradient("+b+", "+c+", "+d+")":"none")}):a.each(this,function(b,c){a.browser.oldmsie?a(c).css("filter","none"):a(c).css("background-image","none")})}}),a.extend({base64:{_strKey:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(b){var c,d,e,f,g,h,i,j=a.base64,k="",l=0;for(b=j._utf8_encode(b||"");l<b.length;)c=b.charCodeAt(l++),d=b.charCodeAt(l++),e=b.charCodeAt(l++),f=c>>2,g=(3&c)<<4|d>>4,h=(15&d)<<2|e>>6,i=63&e,isNaN(d)?h=i=64:isNaN(e)&&(i=64),k=k+j._strKey.charAt(f)+j._strKey.charAt(g)+j._strKey.charAt(h)+j._strKey.charAt(i);return k},decode:function(b){var c,d,e,f,g,h,i,j=a.base64,k="",l=0;for(b=(b||"").replace(/[^A-Za-z0-9\+\/=]/g,"");l<b.length;)f=j._strKey.indexOf(b.charAt(l++)),
g=j._strKey.indexOf(b.charAt(l++)),h=j._strKey.indexOf(b.charAt(l++)),i=j._strKey.indexOf(b.charAt(l++)),c=f<<2|g>>4,d=(15&g)<<4|h>>2,e=(3&h)<<6|i,k+=String.fromCharCode(c),64!=h&&(k+=String.fromCharCode(d)),64!=i&&(k+=String.fromCharCode(e));return k=j._utf8_decode(k)},_utf8_encode:function(a){a=a.replace(/\r\n/g,"\n");for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);d<128?b+=String.fromCharCode(d):d>127&&d<2048?(b+=String.fromCharCode(d>>6|192),b+=String.fromCharCode(63&d|128)):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128),b+=String.fromCharCode(63&d|128))}return b},_utf8_decode:function(a){for(var b,c,d,e="",f=0;f<a.length;)b=a.charCodeAt(f),b<128?(e+=String.fromCharCode(b),f++):b>191&&b<224?(c=a.charCodeAt(f+1),e+=String.fromCharCode((31&b)<<6|63&c),f+=2):(c=a.charCodeAt(f+1),d=a.charCodeAt(f+2),e+=String.fromCharCode((15&b)<<12|(63&c)<<6|63&d),f+=3);return e}},FORM:{createInput:function(b,c,d){for(var e,f,g,h,i=[],j=a.browser.mobile,k=a.extend({id:"",rowspan:0,style:""},c),l='<span class="ntkf-text-red" style="'+a.STYLE_BODY+'padding:2px 5px 2px 0;color:#f00;">'+(d||"")+"</span>",m=0;m<b.length;m++){switch(e=a.extend({titlewidth:"80px",inputwidth:"auto",input:{width:"90%",height:"auto"}},b[m]),h=j?e.title:e.title+(e.title.length==a.enLength(e.title)?":":"："),/zh_cn|zh_tw/.test(a.lang.language)&&a.enLength(e.title)>16||e.multipart||/radio|checkbox/.test(e.type)&&e.options.length>2?(e.multipart=!0,i.push(j?'<tr style="'+a.STYLE_BODY+'"><td style="'+a.STYLE_BODY+'width:100%;"><div class="nt-mobile-form-title" style="'+a.STYLE_BODY+'width:100%; line-height:14px; font-size:14px; font-weight:bold; text-align:center; color:#333333; margin: 15px 0px 20px 0px">'+h+"</div>":['<tr style="',a.STYLE_BODY,'">','<td style="',a.STYLE_BODY,'vertical-align:top;line-height:28px;color:#333;" colspan="2">','<div style="',a.STYLE_BODY,'margin:5px 10px 5px 10px;color:#5a5a5a;">',h,e.required===!0?l:"","</div>","</td>","</tr>",'<tr style="'+a.STYLE_BODY+'"><td style="',a.STYLE_BODY,'padding:0 5px 0 0;text-align:right;vertical-align:top;line-height:28px;color:#333;"></td>','<td style="'+a.STYLE_BODY+"line-height:28px;width:"+e.inputwidth+';">'].join(""))):i.push('<tr style="'+a.STYLE_BODY+'">'+(j?"":'<td style="'+a.STYLE_BODY+"padding:0 5px 0 0;text-align:right;vertical-align:top;line-height:28px;color:#333;width:"+e.titlewidth+';"><div style="'+a.STYLE_BODY+'margin:4px 0 0 0;text-align:right;color:#5a5a5a;">'+(e.required===!0?l:"")+h+"</div></td>")+'<td style="'+a.STYLE_BODY+"line-height:28px;width:"+(j?"100%":e.inputwidth)+';">'),e.type){case"select":i.push('<select data-index="'+m+'" name="'+e.name+'" style="'+a.STYLE_BODY+"border:1px solid #ccc;height:24px;color:#333;margin:0 0 4px;line-height:20px;width:"+(j?"99%":e.input.width)+';">'),i.push('<option value="" style="'+a.STYLE_BODY+'color:#ccc;">'+e.defaultText+"</option>");for(var n=0;n<e.options.length;n++)f=e.options[n],f="string"==typeof f?{text:f,value:f}:f,i.push('<option value="'+f.value+'" style="'+a.STYLE_BODY+'color:#333;">'+f.text+"</option>");i.push("</select>");break;case"radio":i.push('<ul style="'+a.STYLE_BODY+'list-style:none;">');for(var o,p=0;p<e.options.length;p++)f=e.options[p],f="string"==typeof f?{text:f,value:f}:f,o=e.name+"_"+p,g=e.defaultText==f.value?" checked":"",i.push('<li class="form-item" style="'+a.STYLE_BODY+'list-style:none;padding:0 2px 0 0;color:#000;float:left;"><input type="radio" name="'+e.name+'"id="'+o+'" value="'+f.value+'" _custom_text="'+f.text+'" style="'+a.STYLE_BODY+'color:#333;"'+g+' /><label for="'+o+'" style="'+a.STYLE_BODY+'display:inline;color:#000;">'+f.text+"</label></li>");i.push('<li style="'+a.STYLE_BODY+'list-style:none;clear:both;width:0;height:0;"></li>'),i.push("</ul>");break;case"checkbox":i.push('<ul style="'+a.STYLE_BODY+'list-style:none;">');for(var q,r=0;r<e.options.length;r++)f=e.options[r],f="string"==typeof f?{text:f,value:f}:f,q=e.name+"_"+r,g=e.defaultText==f.value?" checked":"",i.push('<li class="form-item" style="'+a.STYLE_BODY+'list-style:none;padding:0 2px 0 0;float:left;"><input type="checkbox" name="'+e.name+'" id="'+q+'" value="'+f.value+'" _custom_text="'+f.text+'" style="'+a.STYLE_BODY+'color:#333;"'+g+' /><label for="'+q+'" style="'+a.STYLE_BODY+'display:inline;color:#000;">'+f.text+"</label></li>");i.push('<li style="'+a.STYLE_BODY+'list-style:none;clear:both;width:0;height:0;"></li>'),i.push("</ul>");break;case"textarea":i.push('<textarea data-index="'+m+'" name="'+e.name+'" style="'+a.STYLE_BODY+"border:1px solid #ccc;color:#ccc;width:"+(j?"99%":e.input.width)+";height:"+e.input.height+';"'+(a.browser.html5?' placeholder="'+e.defaultText+'">':">"+e.defaultText)+"</textarea>");break;default:i.push('<input data-index="'+m+'" type="text" name="'+e.name+'"'+(a.browser.html5?' placeholder="'+e.defaultText+'" value=""':' value="'+e.defaultText+'"')+' maxlength="32" style="'+a.STYLE_BODY+"border:1px solid #ccc;height:24px;width:"+(j?"99%":e.input.width)+';margin:0 0 4px;color:#ccc;"'),"phone"==e.verification&&i.push(" onblur=\"this.value=this.value.replace(/[^0-9-]+/, '');\" onkeyup=\"var keyCode=(event || window.event).keyCode; if( !/16|17|35|36|37|38|39|40/i.test(keyCode) ){this.value=this.value.replace(/[^0-9-]+/, '');}\""),i.push(" />")}e.messageid&&(i.push('<div style="'+a.STYLE_BODY+'display:none;color:#EF7208;" class="form-info '+e.messageid+'">'),i.push('<div style="'+a.STYLE_BODY+"margin:2px;width:15px;height:15px;float:left;background:transparent url("+a.sourceURI+'/images/chaticon.png) no-repeat -160px -39px;"></div>'),i.push('<div style="'+a.STYLE_BODY+'color:#EF7208;float:left;" class="chat-view-info"></div>'),i.push('<div style="'+a.STYLE_BODY+'clear:both;width:0;height:0;"></div>'),i.push("</div>")),i.push("</td>"),k.style&&0===m&&i.push('<td style="'+a.STYLE_BODY+k.style+'" id="'+k.id+'" rowspan="'+k.rowspan+'"></td></tr>')}return i.join("")},bindFormEvent:function(b,c){a(c).find("input[type=text], textarea").bind("focus",function(){var c=a(this).css({color:"#333","border-color":a.browser.mobile?"#0079fe":"#666"}),d=c.attr("data-index")||0,e=b[d].defaultText;e==c.val()&&c.val("")}).bind("blur",function(){var c=a(this).css("border-color","#ccc"),d=c.attr("data-index")||0,e=b[d].defaultText;""===c.val()&&c.val(e),""!==c.val()&&c.val()!=e||c.css("color","#ccc")})},verificationForm:function(b,c,d,e){for(var f,g,h,i,j,k=[],l=!1,m=new RegExp("\\d{6,}","i"),n=new RegExp("^[a-zA-Z0-9\\._-]+@[a-zA-Z0-9_-]+(\\.[a-zA-Z0-9_-]+)+$","i"),o=this,p=function(b,c){c.checked&&(j={value:a(c).val()||"",text:a(c).attr("_custom_text")})},q=function(){a(this).display()},r=0;r<b.length;r++){switch(b[r].type){case"checkbox":j=[],f=a(d).find("input[name="+b[r].name+"]"),g=a(d).find("input[name="+b[r].name+"][checked]");for(var s=0;s<g.length;s++)j.push({value:g.get(s).value,text:a(g.get(s)).attr("_custom_text")});break;case"radio":j={value:"",text:""},f=a(d).find("input[name="+b[r].name+"]"),a(d).find("input[name="+b[r].name+"][checked]").each(p);break;case"select":f=a(d).find("select[name="+b[r].name+"]"),j=a("option[selected]",f).val()||"",j=b[r].defaultText&&j==b[r].defaultText?"":j;break;case"textarea":f=a(d).find("textarea[name="+b[r].name+"]"),b[r].defaultText&&b[r].defaultText==f.val()?(j="",f.val("")):j=f.val().replace(/(^\s*)|(\s*$)/g,"");break;default:f=a(d).find("input[name="+b[r].name+"]"),b[r].defaultText&&b[r].defaultText==f.val()?(j="",f.val("")):j=f.val().replace(/(^\s*)|(\s*$)/g,"")}h="string"==typeof j?""===j||!j.length:a.isArray(j)?0===j.length:""===j.value,i=!(!b[r].messageid||!b[r].message);var t=a(d).find("."+b[r].messageid),u=a(d).find("."+b[r].messageid+" .chat-view-info");b[r].required&&h?(o.showError(i,b[r].message[0],u,t,f,b[r].type),l=!0):("phone"!=b[r].verification||h||m.test(j))&&("email"!=b[r].verification||h||n.test(j))?b[r].min&&!h&&a.enLength(j)<b[r].min?(o.showError(i,b[r].message[1],u,t,f),l=!0):b[r].max&&!h&&a.enLength(j)>b[r].max?(o.showError(i,b[r].message[2],u,t,f),l=!0):(i?t.hide(q):/radio|checkbox/.test(b[r].type)?f.parent().css("color","#333"):f.css("border-color","#DBD8D1"),h||k.push({name:b[r].name,title:b[r].title,value:j})):(o.showError(i,b[r].message[1],u,t,f),l=!0)}return l?void("function"==typeof e&&e()):(a.Log("form submit complete, failCallback is null",3),void("function"==typeof c?c(k):a.Log("form submit complete, callback is null",3)))},showError:function(b,c,d,e,f,g){var h=this;if(b&&c)if(a.browser.mobile){this.messageErrorToast&&(this.messageErrorToast.remove(),this.messageErrorToast=null,this.messageErrorTimeout&&clearTimeout(this.messageErrorTimeout));var i=c.length>10?300:250;this.messageErrorToast=new a.Toast('<div id="#message_error" style="position: relative;width: '+(i-50)+'px; height:30px; line-height: 30px;z-index:100; color: #FFF; top: 30px; left: 25px; text-align:center;font-weight:bold">'+c+"</div>",{width:i,height:90}),this.messageErrorTimeout=setTimeout(function(){h.messageErrorToast.remove(),h.messageErrorToast=null,f.get(0).focus()},2e3)}else d.html(c),e.display(1).show(),f.get(0).focus();else/radio|checkbox/.test(g)?f.parent().css("color","#f00"):f.css("border-color","#f00").get(0).focus()}}}),a.Transfer=a.Class.create(),a.Transfer.prototype={name:"Transfer",button:null,element:null,form:null,iframe:null,proxy:null,options:null,debug:!0,fkey:"",initialize:function(b,d){this.button=d;var e=a.randomChar(16);if(this.options=a.extend({onError:c,onChange:c,callback:c,name:e,curName:"",compSize:512e3,params:{},target:"iframe-transfer-"+e},b),!this.options.server)return void a.Log("server is null",3);this.proxy=a({tag:"IFRAME",name:"proxy-"+e,src:this.options.server.substring(0,this.options.server.lastIndexOf("/"))+"/proxy.html?t="+a.getTime(),style:a.STYLE_NBODY+"width:0px;height:0px;display:none;"}).appendTo(a(this.button)).get(0).contentWindow;var f=this,g=Math.max(20,this.button.width(),parseFloat(this.button.css("width"))),h=Math.max(20,this.button.height(),parseFloat(this.button.css("height"))),i=a.STYLE_BODY+"width:"+g+"px;height:"+h+"px;overflow:hidden;";this.completed=function(a){var b=/^(?:loaded|complete|undefined)$/,c=this.readyState;b.test(c)&&(f.iframe.removeEvent("readystatechange",f.completed).removeEvent("load",f.completed),f.transferComplete(a,f.fkey))},this.form=a({tag:"FORM",action:"",method:"POST",target:this.options.target,enctype:"multipart/form-data",style:i}).appendTo(this.button,!0),this.iframe=a({tag:"IFRAME",name:this.options.target,src:"about:blank",style:i+"width:0;height:0;display:none;"}).appendTo(this.button,!0),this.element=a({tag:"INPUT",type:"file",name:this.options.name,accept:this.options.accept||"*",style:i,title:this.button.attr("title")||""}).appendTo(this.form,!0).css("opacity",0),this.element.click(function(){""!==this.value&&f.form.get(0).reset(),f.iframe.bind("readystatechange",f.completed).bind("load",f.completed),f.fkey=a.randomChar(16)}).bind("change",function(a){var b={};this.files?(b.name=this.files[0].name,b.size=this.files[0].size):(b.name=this.value.substring(this.value.lastIndexOf("\\")+1),b.size=""),b.name&&(f.options.onChange(b),f.fileChange(a,this.files||this.value))})},transferComplete:function(b,c){var d=this;c&&(this.debug&&a.Log("$.upload.transferComplete(event, "+c+")"),a.jsonp(this.options.server+"?"+a.toURI(a.extend({getaction:1,fkey:c},this.options.params))+"#rnd",function(b){d.debug&&a.Log("get transfer file info:"+a.JSON.toJSONString(b),1),b.name=d.options.curName||d.options.name||"",d.options.callback(b)}))},fileChange:function(b,c){var d=this;this.isMobileCompTransf(c,function(e){e?a.browser.oldAndroid?a.require("jpeg_encoder_basic.js?siteid="+d.options.params.siteid,function(a){d.mobileCompTransf(b,c)}):a.browser.oldIOS?a.require("megapix-image.js?siteid="+d.options.params.siteid,function(a){d.mobileCompTransf(b,c)}):d.mobileCompTransf(b,c):d.commonTransf(b,c)})},isMobileCompTransf:function(b,c){if(a.browser.mobile&&(window.URL||window.webkitURL)&&document.createElement("canvas"))if(b[0].name.toLowerCase().indexOf("jpg")>-1)c(!0);else if(window.FileReader&&window.DataView){var d=new FileReader;d.onload=function(a){var b=new DataView(a.target.result);c(255==b.getUint8(0)&&216==b.getUint8(1))},d.readAsArrayBuffer(b[0])}else c(!1);else c(!1)},commonTransf:function(b,c){var d,e,f="uploadfile"==this.options.params.action;try{d=f?this.proxy.fileOptions.fileMaxSize:this.proxy.fileOptions.imageMaxSize,e=f?this.proxy.fileOptions.fileExt:this.proxy.fileOptions.imageExt}catch(g){d=null,e=null}if("string"==typeof c)this.debug&&a.Log("Name: "+c,2);else for(var h,i=0;i<c.length;i++){var j,k=c[i];if(j=k.name.indexOf(".")>-1?k.name.match(/\.[^\.]+$/)[0].replace(".","").toLowerCase():"",this.options.maxSize&&k.size>this.options.maxSize||d&&k.size>d)return void this.options.onError({type:9,name:k.name,size:k.size,etype:"SIZE",maxSize:this.options.maxSize||d});if("*"!=this.options.accept&&this.options.accept||e){if(this.options.accept&&this.options.accept.indexOf("/*")>-1){if(h=new RegExp(this.options.accept.replace(/\//,"\\/"),"gi"),!h.test(k.type))return a.Log("accept:"+this.options.accept+", type:"+k.type,2),void this.options.onError({type:9,name:k.name,size:k.size,etype:"TYPE"})}else{if(this.options.accept&&this.options.accept.indexOf(k.type)<=-1)return a.Log("accept:"+this.options.accept+", type:"+k.type,2),void this.options.onError({type:9,name:k.name,size:k.size,etype:"TYPE"});if(e&&e.indexOf(j)>-1)continue;if(e&&e.indexOf(j)==-1)return void this.options.onError({type:9,name:k.name,size:k.size,ext:e,etype:"TYPE"})}this.options.curName=k.name,this.debug&&a.Log("Name: "+this.options.curName)}}this.debug&&a.Log("$.upload.fileChange()"),this.form.attr("action",this.options.server+"?"+a.toURI(a.extend({fkey:this.fkey,rnd:a.getTime()},this.options.params))),a.browser.mobile&&this.options.callback({status:"startUpload",oldfile:c[0].name}),this.form.get(0).submit()},mobileCompTransf:function(b,c){var d=this;this.options.callback({status:"startCompress",oldfile:c[0].name});new a.ImageOrientation(c[0],function(b,e){new a.CompressImg(c[0],{orientation:e},function(b,e){d.formData=new FormData,d.formData.append("base64",e),d.formData.append("fname",a.getTime()+".jpg"),d.options.action="uploadimage",d.options.siteid=d.options.params.siteid,a.each(d.options,function(a,b){d.formData.append(a,b)}),d.uploadCallBack=function(b){"success"==b.status?(b=b.event.target.responseText,d.options.callback(a.JSON.parseJSON(b))):"error"==b.status&&d.options.callback("error")},d.options.callback({status:"startUpload",oldfile:c[0].name,compress:!0});try{d.proxy.uploadFile(d.options.server,d.formData,d.uploadCallBack)}catch(f){a.Log("base64 upload"+f.message,3)}})})},base64Transf:function(b){var c=this;this.fkey=a.getTime(),new a.POST(this.options.server+"?action=uploadimage",a.extend({base64:b,fname:a.getTime()+".png",fkey:this.fkey,rnd:a.getTime()},this.options.params),function(a){c.transferComplete(a,c.fkey)})}},a.CompressImg=a.Class.create(),a.CompressImg.prototype={ctx:null,canvas:null,url:null,image:null,blob:null,compBlob:null,dataurl:null,resize:{width:null,height:null},options:{width:null,height:null,quality:.7},initialize:function(b,c,d){var e=this;this.url=window.URL||window.webkitURL,this.canvas=document.createElement("canvas"),this.blob="string"==typeof b?b:this.url.createObjectURL(b),this.options=a.extend(c,this.options),this.image=new Image,this.image.onerror=function(){a.Log("加载图片失败！")},this.image.onload=function(b){e.getCompImage(),d(b,e.dataurl);var c=a.browser.oldIOS?1e4:0;setTimeout(function(){for(var a in e)e.hasOwnProperty(a)&&(e[a]=null)},c)},this.image.crossOrigin="*",this.image.src=e.blob},drawOldIOSCanvas:function(){var a=new MegaPixImage(this.image);"5678".indexOf(this.options.orientation)>-1?a.render(this.canvas,{width:this.canvas.height,height:this.canvas.width,orientation:this.options.orientation}):a.render(this.canvas,{width:this.canvas.width,height:this.canvas.height,orientation:this.options.orientation})},drawCanvas:function(){var a=this;switch(a.options.orientation){case 3:this.ctx.rotate(180*Math.PI/180),this.ctx.drawImage(this.image,-this.resize.width,-this.resize.height,this.resize.width,this.resize.height);break;case 6:this.ctx.rotate(90*Math.PI/180),this.ctx.drawImage(this.image,0,-this.resize.width,this.resize.height,this.resize.width);break;case 8:this.ctx.rotate(270*Math.PI/180),this.ctx.drawImage(this.image,-this.resize.height,0,this.resize.height,this.resize.width);break;case 2:this.ctx.translate(resize.width,0),this.ctx.scale(-1,1),this.ctx.drawImage(this.image,0,0,this.resize.width,this.resize.height);break;case 4:this.ctx.translate(resize.width,0),this.ctx.scale(-1,1),this.ctx.rotate(180*Math.PI/180),this.ctx.drawImage(this.image,-this.resize.width,-this.resize.height,this.resize.width,this.resize.height);break;case 5:this.ctx.translate(resize.width,0),this.ctx.scale(-1,1),this.ctx.rotate(90*Math.PI/180),this.ctx.drawImage(this.image,0,-this.resize.width,this.resize.height,this.resize.width);break;case 7:this.ctx.translate(resize.width,0),this.ctx.scale(-1,1),this.ctx.rotate(270*Math.PI/180),this.ctx.drawImage(this.image,-this.resize.height,0,this.resize.height,this.resize.width);break;default:this.ctx.drawImage(this.image,0,0,this.resize.width,this.resize.height)}},getCompImage:function(){var b=this;if(this.ctx=this.canvas.getContext("2d"),this.resize=this._getResize(),this.canvas.width=this.resize.width,this.canvas.height=this.resize.height,this.ctx.fillStyle="#fff",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),a.browser.oldIOS?this.drawOldIOSCanvas():this.drawCanvas(),a.browser.oldAndroid){var c=new JPEGEncoder,d=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height);this.dataurl=c.encode(d,100*this.options.quality)}else this.dataurl=this.canvas.toDataURL("image/jpeg",this.options.quality);this.url.revokeObjectURL(b.blob)},_getResize:function(){var a=this,b=this.image,c=this.options.width,d=this.options.height,e={width:b.width,height:b.height};"5678".indexOf(a.options.orientation)>-1&&(e.width=b.height,e.height=b.width);var f=e.width/e.height;for(c&&d?f>=c/d?e.width>c&&(e.width=c,e.height=Math.ceil(c/f)):e.height>d&&(e.height=d,e.width=Math.ceil(d*f)):c?c<e.width&&(e.width=c,e.height=Math.ceil(c/f)):d&&d<e.height&&(e.width=Math.ceil(d*f),e.height=d);e.width>=3264||e.height>=2448;)e.width*=.8,e.height*=.8;return e}},a.ImageOrientation=a.Class.create(),a.ImageOrientation.prototype={initialize:function(b,c){if(!window.FileReader||!window.DataView)return 1;var d=this,e=new FileReader;e.onload=function(b){c(a.Event.fixEvent(b),d._readImageOrientation(b.target.result))},e.readAsArrayBuffer(b)},_readImageOrientation:function(a){var b=new DataView(a);if(255!=b.getUint8(0)||216!=b.getUint8(1))return 1;for(var c,d=2,e=a.byteLength;d<e;){if(255!=b.getUint8(d))return 1;if(c=b.getUint8(d+1),225==c)return this._getOrientationFromExif(b,d+4,b.getUint16(d+2)-2);d+=2+b.getUint16(d+2)}},_getOrientationFromExif:function(a,b){if("Exif"!=this._getStringFromDB(a,b,4))return 1;var c,d=b+6;if(18761==a.getUint16(d))c=!1;else{if(19789!=a.getUint16(d))return 1;c=!0}if(42!=a.getUint16(d+2,!c))return 1;var e=a.getUint32(d+4,!c);return e<8?1:this._getOrientationFromTag(a,d,d+e,c)},_getOrientationFromTag:function(a,b,c,d){var e,f,g,h=a.getUint16(c,!d);for(g=0;g<h;g++)if(e=c+12*g+2,f=a.getUint16(e,!d),274==f)return this._getOrientationValue(a,e,b,c,d);return 1},_getOrientationValue:function(a,b,c,d,e){var f,g,h,i=a.getUint16(b+2,!e),j=a.getUint32(b+4,!e),k=a.getUint32(b+8,!e)+c;switch(i){case 3:if(1==j)return a.getUint16(b+8,!e);for(f=j>2?k:b+8,g=[],h=0;h<j;h++)g[h]=a.getUint16(f+2*h,!e);return g}},_getStringFromDB:function(a,b,c){var d="";for(n=b;n<b+c;n++)d+=String.fromCharCode(a.getUint8(n));return d}},a.DialogChat=new a.Class.create,a.DialogChat.prototype={contains:null,background:null,iframe:null,display:!1,selector:"",def:{close:!1,parent:window,margin:10,border:0,style:{height:"auto"},resizeFunc:null},options:null,_funcResize:c,initialize:function(b,c){var d=this;this.options=a.extend({},this.def,c),this.id=a.randomChar(),this.selector=".dialog-container-"+this.id,this._create(),this._style(this.options.style),this.display=!0,this.options.close&&(b+='<div class="dialog-button-close" style="'+a.STYLE_NBODY+'font-size:14px;position:absolute;right:10px;top:10px;width:20px;height:20px;line-height:20px;text-align:center;cursor:pointer;">x</div>'),this.container.html(b),setTimeout(function(){d.container.css({top:Math.max(0,(a(d.options.parent).height()-Math.max(d.container.height(),200))/2)+"px"})},5),this._funcResize=function(){d.resize()},this.options.parent==window&&a(window).addEvent("resize",this._funcResize),this.container.find(".dialog-button-close").click(function(){d.close()})},close:function(){var b=this;this.options.parent==window&&a(window).removeEvent("resize",this._funcResize),a(this.selector).hide(function(){a(".dialog-iframe-"+b.id+",.dialog-background-"+b.id).remove(),a(b.selector).remove(),b.display=!1})},resize:function(b,c){b=b||a(this.options.parent).width(),c=c||a(this.options.parent).height(),a(".dialog-iframe-"+this.id+",.dialog-background-"+this.id).css({width:b+"px",height:c+"px"});var d="auto"===this.options.style.height?"auto":c-2*this.options.margin-2*this.options.border;this.container.css({width:b-2*this.options.margin-2*this.options.border+"px",height:"auto"==d?"auto":d+"px","max-width":b+"px","max-height":c-40+"px"}),this.container.css("top",Math.max(0,(c-Math.max("auto"==d?this.container.height():d,200))/2)+"px"),this.options.resizeFunc&&this.options.resizeFunc.call()},_create:function(){var b=this.options.parent==window?document.body:this.options.parent,c=this.options.parent==window?"fixed":"absolute";this.iframe=a({tag:"IFRAME",className:"dialog-iframe-"+this.id,style:a.STYLE_NBODY+"position:"+c+";display:none;left:0;top:0;margin:0;padding:0;border:0;width:100%;z-index:8888;"}).appendTo(b),this.background=a({tag:"div",className:"dialog-background-"+this.id,style:a.STYLE_NBODY+"position:"+c+";left:0;top:0;margin:0;padding:0;border:0;width:100%;background-color:#000;z-index:8888;"}).appendTo(b);var d=a.browser.mobile?9e3:2147483647;this.container=a({tag:"div",className:"dialog-container-"+this.id,style:a.STYLE_BODY+"position:"+c+";left:0;top:0;margin:0;min-height:"+(this.options.minHeight?this.options.minHeight:200)+"px;border-radius:0px;z-index:"+d+";background:#fff;overflow-x:hidden;overflow-y:hidden;"}).appendTo(b),this.background.bind("touchstart",function(b){var c=a.Event.fixEvent(b);c.stopPropagation(),c.preventDefault()}).bind("touchend",function(b){var c=a.Event.fixEvent(b);c.stopPropagation(),c.preventDefault()})},_style:function(b){var c=a(this.options.parent).width(),d=a(this.options.parent).height();a(".dialog-iframe-"+this.id+",.dialog-background-"+this.id).css({width:c+"px",height:a(this.options.parent).height()+"px"}),this.background.css({opacity:.6});var e=(this.options.margin+"").split(" ");1==e.length&&e.push(this.options.margin),this.container.css(b).css({left:e[0]+"px",top:e[1]+"px",width:c-2*e[0]-2*this.options.border+"px",height:"auto"===this.options.style.height?"auto":d-2*e[1]-2*this.options.border+"px"})}},a.Toast=new a.Class.create,a.Toast.prototype={id:null,container:null,toast:null,options:{},initialize:function(b,c){var d=this;this.id=a.randomChar(),this.options=a.extend(this.options,c),this.toastOpacity=a({tag:"div",className:"toast-opacity-"+this.id,style:a.STYLE_BODY+"position:relative;z-index:9000;width:"+this.options.width+"px;height:"+this.options.height+"px;margin-left:"+(a(window).width()-this.options.width)/2+"px;margin-top:"+(a(window).scrollTop()+(a(window).height()-this.options.height-100)/2)+"px;background-color:#000;opacity:0.5;border-radius:5px;font-size:16px;color:white;text-align:center;line-height:"+this.options.height+"px"}),this.toast=a({tag:"div",className:"toast-"+this.id,style:a.STYLE_BODY+"position:relative;z-index:10000;width:"+this.options.width+"px;height:"+this.options.height+"px;margin-left:"+(a(window).width()-this.options.width)/2+"px;margin-top:"+-this.options.height+"px;background-color:none;border-radius:5px;font-size:16px;color:white;text-align:center;line-height:"+this.options.height+"px"}),this.toast.html(b),this._create(),this._funcResize=function(){d.resize()},this._funRemove=function(){d.remove()},a(window).addEvent("resize",this._funcResize)},_create:function(){this.toastOpacity.appendTo(document.body),this.toast.appendTo(document.body)},change:function(b){a(".toast-"+this.id).html(b)},resize:function(){var b=a(window).width(),c=a(window).height(),d=(b-this.options.width)/2>0?(b-this.options.width)/2:0,e=(c-this.options.height-100)/2>0?a(window).scrollTop()+(c-this.options.height-100)/2:a(window).scrollTop();a(".toast-opacity-"+this.id).css({"margin-left":d+"px","margin-top":e+"px","max-width":b+"px","max-height":c+"px"}),a(".toast-"+this.id).css({"margin-left":d+"px","margin-top":-this.options.height+"px","max-width":b+"px","max-height":c+"px"})},remove:function(){a(".toast-opacity-"+this.id).remove(),a(".toast-"+this.id).remove()}},a.GifTimer=a.Class.create(),a.GifTimer.prototype={id:null,inter:null,timeout:null,options:{inTimeFunc:null,outTimeFunc:null,doTime:null,allTime:null},initialize:function(b){var c=this;this.options=a.extend(this.options,b),this.inter=setInterval(function(){c.options.inTimeFunc.call(c)},this.options.doTime),this.timeout=setTimeout(function(){clearInterval(c.inter),c.options.outTimeFunc.call(c)},this.options.allTime)},remove:function(){a.Log("giftimer remove"),clearInterval(this.inter),clearTimeout(this.timeout),this.inter=null,this.timeout=null}},a.Music=a.Class.create(),a.Music.prototype={msgid:null,url:null,type:null,duration:null,audioFlag:!0,musicEl:null,viewCallback:null,eventCallback:null,container:null,debugStr:"[nTalk Music]: ",initialize:function(a,b,c,d,e,f,g){this.msgid=a,this.url=b,this.type=c,this.duration=d,this.viewCallback=e,this.eventCallback=f,this.container=g,this.audioFlag=this.canPlayAudioMP3(),this.audioFlag?this.createAudioPlayer():this.createSwfPlayer(),this.viewCallback.call(this,"init"),this.eventCallback.call(this,"init")},createAudioPlayer:function(){var b=this;this.musicEl=document.createElement("audio"),this.musicEl.src=this.url,this.musicEl.type=this.type,this.musicEl.stop=function(){this.pause(),this.currentTime=0},a.Event.addEvent(this.musicEl,"ended",function(){a.Log(b.debugStr+" trigger ended stop mp3"),b.viewCallback.call(b,"stop")}),this.musicEl.getPaused=function(){return this.paused}},createSwfPlayer:function(){var b=this,c="ntalker_swf_mp3Player_container_"+this.msgid,d="ntalker_swf_mp3player_"+this.msgid,e=a.sourceURI+"fs/music.swf",f=a.flashHtml(d,e,"id="+d);this.musicEl=document.createElement("div"),this.musicEl.innerHTML+=f,this.musicEl.id=c,this.container.append(this.musicEl.outerHTML);var g=a.browser.msie&&a.browser.ieversion<=7?window[d]:document[d];setTimeout(function(){g.emit("load",b.url),g.emit("stop"),b.musicEl.play=function(){g.emit("play")},b.musicEl.stop=function(){g.emit("stop")},b.musicEl.getPaused=function(){return 0===g.getPaused()}},1e3)},emit:function(){this.musicEl.getPaused()?this.play():this.stop()},play:function(){a.Log(this.debugStr+"play mp3"),this.musicEl.play(),this.viewCallback.call(this,"play")},stop:function(){a.Log(this.debugStr+"stop mp3"),this.musicEl.stop(),this.viewCallback.call(this,"stop")},canPlayAudioMP3:function(){try{var a=document.createElement("audio");return!(!a.canPlayType||!a.canPlayType("audio/mpeg;").replace(/no/,""))}catch(b){return!1}}},a.paste=a.Class.create(),void(a.paste.prototype={data:null,callback:null,debugStr:"[nTalk pasteDate]: ",initialize:function(a,b){this.data=a.clipboardData||window.clipboardData,this.callback=b},getImgBase64Str:function(){var b=this,c=this.data;if(!c)return null;if("function"==typeof webInfoChanged)this.callback(c.getData("image/x-vnd.adobe.air.bitmap").toDataURL());else if(a.browser.chrome||a.browser.opera){var d,e,f=c.items;if(f){d=f[0],e=c.types||[];for(var g=0,h=e.length;g<h;g++)if("Files"===e[g]){d=f[g];break}if(d&&"file"===d.kind&&d.type.match(/^image\//i)){var i=d.getAsFile(),j=new FileReader;j.onload=function(a){b.callback(a.target.result)},j.readAsDataURL(i)}else this.callback()}}else this.callback()}}))}(nTalk);
/* @file im.js
 * @date 2016.12.08 23:09:16 
 */
!function(a,b){var c="nTalk-flash-element",d="ntkf_flash_impresence",e="IM_",f="JDATA_",g="machineid",h=e+"CURRENT_PAGE",i=e+"CUREENT_CONNECT",j=e+"SEND_CURRENT_PAGE_DATA",k="margin:0;padding:0;border:none;float:none;font:normal normal normal 12px/160% Arial,SimSun;",l=e+"EXIST_PAGEARR";a.im||(a.tipsicon=a.sourceURI+"images/tipsicon."+(a.browser.msie6?"gif":"png"),a.extend({CON_LCRM_FIX:"LCRM_",currentCount:0,im:{connect:null,time:3,args:null,options:null,tipElement:null,receiveMsgCount:0,isInvite:!1,start:function(){var b=this;return this.connect?void a.Log("im connected",2):(this.options={siteid:a.global.siteid,settingid:a.global.settingid,surl:a.server.flashserver,r:a.baseURI,ref:a.referrer,fsid:a.global.trailid,cid:a.global.pcid,presenceserver:a.server.presenceserver,presencegoserver:a.server.presencegoserver,t2dstatus:a.server.t2dstatus,crmcenter:a.server.crmcenter,coopserver:a.server.coopserver,loadnid:a.CON_LOAD_MODE_NID},a.user.id&&(this.options=a.merge(this.options,a.whereGet(a.user,["id","name"],["u","n"]))),void a.require({comet:"nt2.js?siteid="+a.extParmas.siteid},function(c){return c?(b.connect=new a.connectPresence(b.options,a.server.close_im_flash||"0",a.server.connect_type),a.IMPRESENCE=b.connect,a.promptwindow.callbackFocus=function(){b.onPageFocus()},a.promptwindow.callbackBlur=function(){b.onPageBlur()},a.listenMouseOutEvent(),setInterval(function(){b.intervalVerify()},5e3),void(a.moveCheck=setInterval(function(){0===a.moveTime&&1==a.currentCount&&a.moveCheckFlag&&(a.moveCheckFlag=!1,setTimeout(function(){0===a.moveTime&&1==a.currentCount&&a.showBeforeLeavePlan(),a.moveCheckFlag=!0},2e3))},1e3))):void a.Log("Loaded $comet mode failed",3)}))},callReceiveSysMessage:function(b,c){var d,e,f;switch(e=b.id||"",!b.settingid&&e&&(f=e.split("_").splice(0,2).join("_"),b.settingid=a.global.settingid.indexOf(f)>-1||f.indexOf("kf_")?a.global.settingid:f+"_9999"),b.calltype){case 10:a.browser.mobile&&a.global.pageinchat?a.isFunction(im_receiveMessage)&&im_receiveMessage(b.settingid,c):a.chatManage&&(d=a.chatManage.get(b.settingid,e))?(d.reconnect(null,e,-1),a.chatManage.callReceive(d.settingid)):3==a.server.isnoim?a.im_openInPageChat(b.settingid,"",e,{single:-1,autoconnect:!0},""):nTalk.global.siteid==b.eid&&a.im.showTips(b,c);break;case 1:case 2:a.base.startLCrm(b.content);break;default:b.autoOpen||3==a.server.isnoim?(a.im&&a.im.refuseInvite(e,b.inviteid,0),a.chatManage&&(d=a.chatManage.get(b.settingid,e))?(d.reconnect(null,e,-1),a.chatManage.callReceive(d.settingid)):a.im_openInPageChat&&a.im_openInPageChat(b.settingid,"",e,{single:-1,autoconnect:1},"")):this.showTips(b,c,!0)}},onPageFocus:function(){a.IMPRESENCE.setPageFocus(!0,a.title,a.url,0),this.intervalVerify()},onPageBlur:function(){a.IMPRESENCE.setPageFocus(!1)},intervalVerify:function(){var b,c;b=a.loadLCrm(),a.each(b,function(b,d){1!=d.trigger&&a.im.connect.currentPage.get()&&(c=a.extend(d,{cw:a.currentCount}),a.base.startLCrm(c,!1,!0),a.flashData.remove(a.CON_LCRM_FIX+c.token))})},showTips:function(b,c,d){var e;this.settingid=b.settingid||a.global.settingid||"",this.destid=b.id||"",this.sessionid=b.sid||"",this.inviteid=b.inviteid||"",this.isInvite=d,"function"==typeof window.webInfoChanged&&webInfoChanged(400,'{"num":'+ ++this.receiveMsgCount+', "showNum":1}',!1),e=this.destid.split("_ISME9754_T2D_"),this.sellerid=e[0].indexOf("kf_")>-1||e[0]==a.global.siteid?"":e[0],a.require(a.tipsicon,function(b){b.error&&a.Log("cache chat icon failure",3)}),this._createTips(),this.tipElement.find(".ntalk-tips-body").html(c),this.tipElement.find(".ntalk-tips-button").html("立刻咨询"),a.promptwindow.startPrompt("",a.lang.news_new,!0)},hideTips:function(){var b=this;this.tipElement&&this.tipElement.length&&this.tipElement.hide(500,function(){a(this).remove(),b.tipElement=null})},openChat:function(){this.hideTips(),a.browser.mobile||!a.global.pageinchat?a.im_openOutPageChat(this.settingid,"",this.destid,{manual:1},"",this.sellerid):a.im_openInPageChat(this.settingid,"",this.destid,{single:-1,autoconnect:this.isInvite?-1:1,manual:1},"")},_createTips:function(){var b=this;if(!this.tipElement||!this.tipElement.length){var c=['<div class="ntalk-tips-background" style="margin:0;padding:10px;border:0;background:url(',a.tipsicon,') no-repeat 0 0;color:#333333;font:normal 12px/160% Arial,SimSun;text-align:left;height:150px;width:205px;">','<div class="ntalk-tips-body" style="margin:0;padding:0;border:0;float:left;font:normal 12px/160% Arial,SimSun;color:#333;height:60px;overflow:hidden;text-align:left;white-space:normal;width:156px;word-break:break-all;"></div>','<div class="ntalk-tips-close" style="background:url(',a.tipsicon,') no-repeat -7px -120px;margin:5px;padding:0;border:0;cursor:pointer;font:normal 1px/1px Arial;height:20px;left:166px;position:absolute;top:0px;width:20px;"></div>','<div class="ntalk-tips-button" style="background:#008CD4;margin:0;padding:0;border:0;color:#FFFFFF;cursor:pointer;height:24px;left:105px;font:normal 12px/24px Arial,SimSun;position:absolute;text-align:center;top:78px;width:69px;"></div>',"</div>"].join("");this.tipElement=a({className:"ntalk-tips-container",style:k+"width:206px;height:112px;z-index:99999;"}).appendTo(!0).fixed({right:0,bottom:0}).html(c),this.tipElement.click(function(c){a.Event.fixEvent(c).stopPropagation(),b.openChat()}),this.tipElement.find(".ntalk-tips-button").click(function(c){a.Event.fixEvent(c).stopPropagation(),b.openChat()}).hover(function(b){a(this).css("background","#007AB9")},function(b){a(this).css("background","#008CD4")}),this.tipElement.find(".ntalk-tips-close").click(function(c){a.Event.fixEvent(c).stopPropagation(),b.hideTips()}).hover(function(b){a(this).css("background-position","-27px -120px")},function(b){a(this).css("background-position","-7px -120px")})}},refuseInvite:function(b,c,d){if(!a.server.presencegoserver)return void a.Log("presencegoserver is null",2);if(!b||!c)return void a.Log("auto invite",1);var e={action:"",query:"invtrst",suid:a.user.id,duid:b,rst:d,invid:c,tk:a.global.userToken};a.require(a.server.presencegoserver+"?"+a.toURI(e)+"#rnd")}}}),a.extend({listenMouseEvent:!1,lcrmGoAwayClientY:0,lcrmGoAwayView:!1,moveTime:0,moveCheck:null,moveCheckFlag:!0,loadLCrm:function(){var b=a.flashData.get(),c={};for(var d in b)"function"!=typeof b[d]&&b[d]&&d.indexOf(a.CON_LCRM_FIX)>-1&&(c[d]=b[d]);return c},listenMouseOutEvent:function(b){var c=this,d=function(b){var d=a.Event.fixEvent(b);!d.relatedTarget&&!d.toElement||c.lcrmGoAwayView||c.setMouseOutWindow(d,!1)},e=function(b){var d=a.Event.fixEvent(b);d.relatedTarget||d.toElement||(c.setMouseOutWindow(d,!0),c.moveTime=0)},f=function(b){var d=a.Event.fixEvent(b);c.setMouseOutWindow(d,"mousemove"),null!==a.moveCheck&&(a.moveCheck=null),c.moveTime=a.getTime()};this.listenMouseEvent||a.browser.mobile||(this.listenMouseEvent=!0,b===!0?(a(document).removeEvent("mouseover",d),a(document).removeEvent("mouseout",e),a(document).removeEvent("mousemove",f)):(a(document).addEvent("mouseover",d),a(document).addEvent("mouseout",e),a(document).addEvent("mousemove",f)))},setMouseOutWindow:function(b,c){var d=this;if("mousemove"===c)return void(this.lcrmGoAwayClientY=b.clientY>0?b.clientY:this.lcrmGoAwayClientY);if(this.lcrmGoAwayView=c,b.clientY<0&&d.lcrmGoAwayClientY<50){if(1!=a.currentCount)return;setTimeout(function(){0===a.moveTime&&a.showBeforeLeavePlan()},500)}},_getExistPageList:function(){try{return a.store.get(l).split(",")}catch(b){return[]}},showBeforeLeavePlan:function(){var b,c;b=a.loadLCrm(),a.each(b,function(b,d){0!==d.trigger&&(c=a.extend(d,{trigger:0,cw:a.currentCount}),a.base.startLCrm(c,!1,!0),a.flashData.remove(a.CON_LCRM_FIX+c.token))})}}),a.extend({fIM_onPresenceReceiveSysMessage:function(b,c){return a.Log('$.fIM_onPresenceReceiveSysMessage("'+b+'", "'+a.JSON.toJSONString(c)+'")',1),setTimeout(function(){var b,d,e;d=a.clearHtml(c.substr(0,c.indexOf("ntalker://"))),e=c.substr(c.indexOf("ntalker://")+10);try{b=a.JSON.parseJSON(e)}catch(f){return void a.Log("nTalk.fIM_onPresenceReceiveSysMessage():"+f.message,3)}a.im.callReceiveSysMessage(b,d)},0),!0},fIM_onGetFlashServer:function(a,b,c,d,e,f,g){return!0},connectStatus:-1,fIM_updateUserStatus:function(b,c){return setTimeout(function(){if(a.Log("$.fIM_updateUserStatus("+b+', "'+c+'")'),a.connectStatus=b,2==a.connectStatus)try{a.IMPRESENCE.setPageFocus(!0,a.title,a.url,1)}catch(d){a.Log(d,3)}},0),!0},fIM_presenceSetIMSid:function(b){return a.Log("fIM_presenceSetIMSid(userToken:"+b+")",1),a.global.userToken=b,!0},fIM_presenceSetMyClientID:function(b){return a.url_presenceFlashGoUrl=b,!0},flashData:{debug:!1,reNumber:0,sessionData:null,checkFlash:function(b){if(a.IMPRESENCE&&a.isFunction(a.IMPRESENCE.setJSData))b.call(this);else{if(this.reNumber>3)return;this.reNumber++,setTimeout(b,500)}},add:function(b,c){c&&(c=this.filter(a.JSON.toJSONString(c),!0)),this.debug&&a.Log("$.flashData.add(k:"+b+", v:"+c+")",1),this.checkFlash(function(){try{return a.IMPRESENCE.setJSData(a.global.trailid,b,c),!0}catch(d){return!1}})},remove:function(a){this.add(a,null,!1)},clearAll:function(){this.checkFlash(function(){try{return NTKF.IMPRESENCE.setJSData("","",""),!0}catch(a){return!1}})},get:function(b){var c,d={};if(!a.IMPRESENCE||!a.IMPRESENCE.getJSData)return d;c=a.IMPRESENCE.getJSData(a.global.trailid,b||"");try{c=a.JSON.parseJSON(c)}catch(e){}if("string"==typeof c)d=a.JSON.parseJSON(this.filter(c,!1)||"{}");else for(var f in c)if(!a.isFunction(c[f]))try{d[f]=a.JSON.parseJSON(this.filter(c[f],!1))}catch(e){}return d},filter:function(a,b){return b===!0?a.replace(/\"/gi,"{sy}"):a.replace(/\{sy\}/gi,'"')}}}),a.connectPresence=a.Class.create(),a.connectPresence.prototype={name:"connectPresence",options:null,manage:null,debug:!1,data:null,switchTimeId:null,_connected:!1,currentConnectType:"",initialize:function(b,c,d){var e;switch(this.data=a.store,this.options=a.extend({nullparam:"",usemqtt:0},b),d){case"mqtt":this.options.usemqtt=1,e="WebSocket"in window||"MozWebSocket"in window?"websock":"1"==c?"comet":"fssock";break;case"rtmp":"1"==c?e="comet":a.flash.support&&(e="rtmp")}switch(e){case"websock":this.connect=this._createMqttConnect(this.options);break;case"fssock":case"rtmp":this.connect=this._createFlashConnect(this.options);break;default:this.options.usemqtt=0,this.connect=this._createCometConnect(this.options)}a.Log("new $.connectPresence(); conType: "+e+", isnoim:"+a.server.isnoim),this.connect.manage?this.manage=this.connect.manage:this.manage=new a.pageManage,this.manage.options.onChanage=function(b,c){a.currentCount=b,a.Log("page manage callback: current open window number:"+a.currentCount,1)},a.currentCount=this.manage.count,this.identid=this.manage.identid,this.connect.currentPage?this.currentPage=this.connect.currentPage:(a.Log("new $.CurrentPage("+this.identid+")",1),this.currentPage=new a.CurrentPage(this.identid,this.manage))},switchConnect:function(){this.stopSwitchConnect(),this.currentConnectType!=a.CON_CONNECT_COMET?(a.Log("Flash abnormalities, switch the connection type. this.currentConnectType:"+this.currentConnectType+" > comet",2),this.connect&&a.isFunction(this.connect.remove)&&a.flash.remove(this.connect),this.connect&&a.isFunction(this.connect.disconnect)&&this.connect.disconnect()):a.Log("Flash abnormalities",2)},stopSwitchConnect:function(){clearTimeout(this.switchTimeId),this.switchTimeId=null},setPageFocus:function(a,b,c,d){a&&this.currentPage.set(b,c)},closePresence:function(){if(this.connect)try{this.connect.closePresence()}catch(b){}this.currentConnectType==a.CON_CONNECT_FLASH&&a.flash.remove(this.connect),this.connect=null,this.manage=null},setJSData:function(a,b,c){var d;if(a=arguments[0],a&&""!==a)b=f+a+"-"+arguments[1],this.data.set(b,arguments[2]);else{d=this.data.getAll();for(var e in d)d.hasOwnProperty(e)&&e.indexOf(f)>-1&&this.data.remove(e)}},getJSData:function(b,c){var d,e={};d=this.data.getAll();for(var g in d)"function"!=typeof d[g]&&g.indexOf(f)>-1&&(e[g]=d[g]);return a.JSON.toJSONString(e)},_createFlashConnect:function(b){a.Log("$.connectPresence._createFlashConnect()",1);var e=a("#"+c),f=a.sourceURI+"fs/impresence.swf?"+a.version.im,g=a.flashHtml(d,f,b);return this.currentConnectType=a.CON_CONNECT_FLASH,e.length||(e=a(document.body).insert('<div id="'+c+'" class="nTalk-hidden-element" style="position: absolute; z-index: 9996; top: -200px;"></div>')),e.insert(g),a.browser.msie&&e.find("#"+d).display(1),e.find("#"+d).get(0)},_createCometConnect:function(b){return a.Log("$.connectPresence._createCometConnect()",1),this.currentConnectType=a.CON_CONNECT_COMET,new a.IMPresence(b)},_createMqttConnect:function(b){return a.Log("$.connectPresence._createMqttConnect()",1),this.currentConnectType=a.CON_CONNECT_COMET,new a.IMPresence(b)}},a.IMPresence=a.Class.create(),a.IMPresence.prototype={name:"IMPresence",options:null,connectParams:["userid","username","token","sessionid","nullparam","nullparam","nullparam","siteid","nullparam","nullparam","connectType","pcid","nullparam"],connect:null,debug:!1,login:!1,currentPage:null,_reCount:0,_waitTime:500,_currentConnected:!1,_waitReconnectTimeID:null,_mqttFlag:!0,initialize:function(b){var c=this;this._wsFlag=1==b.usemqtt,this.options=a.extend({nullparam:""},a.whereGet(b,["siteid","settingid","cid","surl","u","n","s","r","ref","fsid"],["siteid","settingid","pcid","serverurl","userid","username","sessionid","resourceurl","referrer","flashsessionid"])),this.data=a.store,this._reCount=0,(!this.options.pcid||this.options.pcid.length<=10)&&(this.options.pcid=this.data.get(g),(!this.options.pcid||this.options.pcid.length<=10)&&(this.options.pcid=a.base._createScriptPCID()));try{this.data.set(g,this.options.pcid)}catch(d){a.Log(d,3)}this.options.userid||(this.options.userid=a.base.userIdFix+this.options.pcid.substr(0,21)),this._callback("fIM_presenceFlashReady",[this.options.userid,this.options.pcid]);var e={onInterval:function(a,b){c._onInterval.call(c,a,b)},onChanage:function(a,b){c._onChanage.call(c,a,b)}};this.manage=new a.pageManage(e),this.identid=this.manage.identid,this.currentPage=new a.CurrentPage(this.identid,this.manage),this.setPageFocus(!0,a.title,a.url)},loginConnect:function(){var b=this,c="",d=this._toArray(this.options,this.connectParams);if(this.debug&&a.Log("im.loginConnect()"),this._callback("fIM_updateUserStatus",[1,""]),a.server.presenceserver){for(var e=a.server.presenceserver.split(";"),f=0;f<e.length;f++)e[f].indexOf("ws://")>-1&&(c=e[f]);c||(this._wsFlag=!1),this._wsFlag?this.connect=new a.mqttws({url:c,siteid:b.options.siteid,pcid:b.options.pcid,onCallback:function(){b._onCallback.apply(b,arguments)},loginMsg:a.JSON.toJSONString({method:"roomConnect",params:d})}):(this.connect=new a.comet(a.server.presencegoserver,{timeout:20,onCallback:function(){b._onCallback.apply(b,arguments)},onComplete:function(a){b._onComplete.apply(b,arguments)},onAbnormal:function(a){b._onAbnormal.apply(b,arguments)},onTimeout:function(a){b._onTimeout.apply(b,arguments)}}),this.connect.connect({action:"conn",params:d.join(",")},"callback"))}},kaliveConnect:function(){this.debug&&a.Log("$.IMPresence.kaliveConnect()",1);var b,c=this;if(this._wsFlag)b={method:"remoteKeepAlive",params:[null,this.options.userid,this.options.clientid]},this.connect.kalive(a.JSON.toJSONString(b));else{var d=this._toArray(this.options,this.connectParams);b={action:"kalive",params:d.join(","),clientid:this.options.clientid,machineid:this.options.pcid,token:this.options.token,uid:this.options.userid},setTimeout(function(){c.connect.kalive(b,"callback")},1e3)}},reconnect:function(){var b=this;++this._reCount<=3?this._waitTime=500:this._waitTime=1e3*+"034567890".charAt(Math.ceil(5*Math.random())),this.debug&&a.Log("$.IMPresence.reconnect() wait:"+this._waitTime,1),this._waitReconnectTimeID=setTimeout(function(){b.connect.reconnect()},this._waitTime)},disconnect:function(){var a=this.data.getAll();for(var b in a)"function"!=typeof a[b]&&b.indexOf(f)>-1&&this.data.remove(b);clearTimeout(this._waitReconnectTimeID),this._waitReconnectTimeID=null},LoginResult:function(a,b,c,d){this.login=a,this.options.clientid=c,this.options.token=d,this._callback("fIM_updateUserStatus",[this.login?2:0,""]),this._callback("fIM_presenceSetIMSid",[this.login?this.options.token:""]),this.login?this.kaliveConnect("call kalive"):this.reconnect("login relogin")},remoteNotifyChatWithGroup:function(b,c,d,e,f,g,h,i){var j,k,l;if(!h)return void(this.debug&&a.Log("message content is null",3));k=a.clearHtml(h.substr(0,h.indexOf("ntalker://"))),l=h.substr(h.indexOf("ntalker://")+10);try{j=a.JSON.parseJSON(l)}catch(m){}a.store.isStorageSupported?this._sendMessage2CurrenPage(k+"ntalker://"+l):this._callback("fIM_onPresenceReceiveSysMessage",[1,k+"ntalker://"+l])},remoteNotifyUserCode:function(b){a.Log("do remoteNotifyUserCode!!!")},remoteConfirmAddFriend:function(b){a.Log("do remoteConfirmAddFriend")},_handleResponse:function(b,c){this[b]?this[b].apply(this,c):a.Log("The object of the method '"+b+"' does not exist",3)},_callback:function(b,c){if(a.hasOwnProperty(b))try{a[b].apply(this,c)}catch(d){}else a.Log("nTalk."+b+"(...)",2)},_onCallback:function(b,c){var d,e=this;if(this.debug&&a.Log("$.IMPresence.onCallback(  )"),c.length)if(d=c[0],/LoginResult|LoginReslut/gi.test(d)){if(!b)return;this.LoginResult.apply(e,c.slice(1))}else this._handleResponse.call(e,d,c.slice(1)),b&&this.kaliveConnect("call kalive")},_onComplete:function(){var b=Array.prototype.slice.call(arguments);this.debug&&a.Log("$.IMPresence.onComplete( "+b[0]+","+b[1]+","+b[2]+" )"),"kalive"==b[0]?this.kaliveConnect("complete kalive"):"login"==b[0]&&this.reconnect("abnormal login")},_onAbnormal:function(){var b=Array.prototype.slice.call(arguments);this.debug&&a.Log("$.IMPresence.onAbnormal( "+b[0]+","+b[1]+","+b[2]+" )",3),"login"==b[0]?this.reconnect("abnormal login"):this.kaliveConnect("abnormal kalive")},_onTimeout:function(){var b=Array.prototype.slice.call(arguments);this.debug&&a.Log("$.IMPresence.onTimeout( "+b[0]+","+b[1]+","+b[2]+" )",3),"login"==b[0]?this.reconnect("time login"):this.kaliveConnect("timeout kalive")},_onInterval:function(b,c){if(this.currentConn=this.data.get(i)||{identid:"",time:0},this.currentConn.identid&&this.currentConn.identid===this.identid)this.currentConn.time=a.getTime(),this.data.set(i,this.currentConn),this._fireEvent("update");else{var d;if(a.isArray(c))for(var e=0;e<c.length;e++)page=c[e],page&&page[this.currentConn.identid]&&(d=!0,this._currentConnected=!0);if(this.currentConn.identid&&this.currentConn.identid!==this.identid&&!d&&(this.currentConn.identid="",this._currentConnected=!1,this._fireEvent("clear")),this.debug&&a.Log("currentConnect>>_onInterval:"+a.JSON.toJSONString(this.currentConn)+", _currentConnected:"+this._currentConnected),this.currentConn.identid&&""!==this.currentConn.identid||this._currentConnected)this._fireEvent("wait");else{this.currentConn={identid:this.identid,time:a.getTime()},this._currentConnected=!0;try{this.data.set(i,this.currentConn)}catch(f){a.Log(f,3)}this._fireEvent("add"),this.loginConnect()}}},_onChanage:function(a,b){this.pageCount=a},_fireEvent:function(b){1!=this.temp&&this.temp?this.temp>=5&&(this.temp=0):(this.temp=1,this.debug&&"wait"!==b&&a.Log(this.identid+", "+b+" long connect, curPage:"+this.currentPage.get(),2)),this.temp++,this._currentGetMessage()},_toArray:function(a,b){var c=[];if(!a)return"error";for(var d=0;d<b.length;d++)c.push(a[b[d]]||"");return c},_sendMessage2CurrenPage:function(b){var c=this.data.get(j);b&&(this.Queue||(this.Queue=new a.Queue),c?this.Queue.enQueue({data:b}):this.data.set(j,b))},_currentGetMessage:function(){var b=this.data.get(j);if(b){try{b=a.JSON.parseJSON(b)}catch(c){}if(this.currentPage.get()&&b&&(this.data.remove(j),this._callback("fIM_onPresenceReceiveSysMessage",[1,b]),this.Queue)){var d=this.Queue.deQueue();d&&this._sendMessage2CurrenPage(d.data)}}},setPageFocus:function(a,b,c,d){a===!0&&this.currentPage.set(b,c)},closePresence:function(){if(this._wsFlag)this.connect.disconnect();else try{this.cometd.disconnect(!0)}catch(a){}this.data.remove(i)},setJSData:function(){var a,b,c=arguments[0];if(c&&""!==c)b=f+c+"-"+arguments[1],this.data.set(b,arguments[2]);else{a=this.data.getAll();for(var d in a)"function"!=typeof a[d]&&d.indexOf(f)>-1&&this.data.remove(d)}},getJSData:function(){var b,c={},d=Array.prototype.slice.call(arguments,0,2).slice(0,2).join("-");if(d&&arguments[1])return a.JSON.toJSONString(this.data.get(d));b=this.data.getAll();for(var e in b)"function"!=typeof b[e]&&e.indexOf(f)>-1&&(c[e]=b[e]);return a.JSON.toJSONString(c)}},a.CurrentPage=a.Class.create(),a.CurrentPage.prototype={name:"CurrentPage",cachePageData:null,identid:"",debug:!1,manage:null,initialize:function(b,c){return b?(this.identid=b,this.manage=c,void(this.data=a.store)):void a.Log("$.CurrentPage params failed",3)},set:function(b,c){return b&&c?(this.cachePageData={identid:this.identid,title:b,url:c},this.debug&&a.Log("$.CurrentPage.set():"+a.JSON.toJSONString(this.cachePageData),1),void this.data.set(h,this.cachePageData)):(a.Log("title is null, url is null"),!1)},get:function(){var b,c=!1;if(this.cachePageData=this.data.get(h),!this.cachePageData||a.isEmptyObject(this.cachePageData))return!1;var d=a._getExistPageList();if(d.length>0){for(var e=0;e<d.length;e++)if(b=d[e],b==this.cachePageData.identid){c=!0;break}if(c===!1&&this.identid==d[d.length-1])return this.set(a.title,a.url),!0}this.debug&&(a.Log("::"+a.JSON.toJSONString(this.cachePageData)),a.Log("cache page identid:"+this.cachePageData.identid+", identid:"+this.identid+", currentPage: "+(this.cachePageData.identid==this.identid)));try{return this.cachePageData.identid==this.identid}catch(f){return!1}}})}(nTalk);